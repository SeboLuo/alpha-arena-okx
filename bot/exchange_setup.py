"""äº¤æ˜“æ‰€è®¾ç½®æ¨¡å—"""
from .config import exchange, TRADE_CONFIG
from .position_manager import get_current_position


def setup_exchange():
    """è®¾ç½®äº¤æ˜“æ‰€å‚æ•° - å¼ºåˆ¶å…¨ä»“æ¨¡å¼"""
    try:

        # é¦–å…ˆè·å–åˆçº¦è§„æ ¼ä¿¡æ¯
        print("ğŸ” è·å–BTCåˆçº¦è§„æ ¼...")
        markets = exchange.load_markets()
        btc_market = markets[TRADE_CONFIG['symbol']]

        # è·å–åˆçº¦ä¹˜æ•°
        contract_size = float(btc_market['contractSize'])
        print(f"âœ… åˆçº¦è§„æ ¼: 1å¼  = {contract_size} BTC")

        # å­˜å‚¨åˆçº¦è§„æ ¼åˆ°å…¨å±€é…ç½®
        TRADE_CONFIG['contract_size'] = contract_size
        TRADE_CONFIG['min_amount'] = btc_market['limits']['amount']['min']

        print(f"ğŸ“ æœ€å°äº¤æ˜“é‡: {TRADE_CONFIG['min_amount']} å¼ ")

        # å…ˆæ£€æŸ¥ç°æœ‰æŒä»“
        print("ğŸ” æ£€æŸ¥ç°æœ‰æŒä»“æ¨¡å¼...")
        positions = exchange.fetch_positions([TRADE_CONFIG['symbol']])

        has_isolated_position = False
        isolated_position_info = None

        for pos in positions:
            if pos['symbol'] == TRADE_CONFIG['symbol']:
                contracts = float(pos.get('contracts', 0))
                mode = pos.get('mgnMode')

                if contracts > 0 and mode == 'isolated':
                    has_isolated_position = True
                    isolated_position_info = {
                        'side': pos.get('side'),
                        'size': contracts,
                        'entry_price': pos.get('entryPrice'),
                        'mode': mode
                    }
                    break

        # 2. å¦‚æœæœ‰é€ä»“æŒä»“ï¼Œæç¤ºå¹¶é€€å‡º
        if has_isolated_position:
            print("âŒ æ£€æµ‹åˆ°é€ä»“æŒä»“ï¼Œç¨‹åºæ— æ³•ç»§ç»­è¿è¡Œï¼")
            print(f"ğŸ“Š é€ä»“æŒä»“è¯¦æƒ…:")
            print(f"   - æ–¹å‘: {isolated_position_info['side']}")
            print(f"   - æ•°é‡: {isolated_position_info['size']}")
            print(f"   - å…¥åœºä»·: {isolated_position_info['entry_price']}")
            print(f"   - æ¨¡å¼: {isolated_position_info['mode']}")
            print("\nğŸš¨ è§£å†³æ–¹æ¡ˆ:")
            print("1. æ‰‹åŠ¨å¹³æ‰æ‰€æœ‰é€ä»“æŒä»“")
            print("2. æˆ–è€…å°†é€ä»“æŒä»“è½¬ä¸ºå…¨ä»“æ¨¡å¼")
            print("3. ç„¶åé‡æ–°å¯åŠ¨ç¨‹åº")
            return False

        # 3. è®¾ç½®å•å‘æŒä»“æ¨¡å¼
        print("ğŸ”„ è®¾ç½®å•å‘æŒä»“æ¨¡å¼...")
        try:
            exchange.set_position_mode(False, TRADE_CONFIG['symbol'])  # Falseè¡¨ç¤ºå•å‘æŒä»“
            print("âœ… å·²è®¾ç½®å•å‘æŒä»“æ¨¡å¼")
        except Exception as e:
            print(f"âš ï¸ è®¾ç½®å•å‘æŒä»“æ¨¡å¼å¤±è´¥ (å¯èƒ½å·²è®¾ç½®): {e}")

        # 4. è®¾ç½®å…¨ä»“æ¨¡å¼å’Œæ æ†
        print("âš™ï¸ è®¾ç½®å…¨ä»“æ¨¡å¼å’Œæ æ†...")
        exchange.set_leverage(
            TRADE_CONFIG['leverage'],
            TRADE_CONFIG['symbol'],
            {'mgnMode': 'cross'}  # å¼ºåˆ¶å…¨ä»“æ¨¡å¼
        )
        print(f"âœ… å·²è®¾ç½®å…¨ä»“æ¨¡å¼ï¼Œæ æ†å€æ•°: {TRADE_CONFIG['leverage']}x")

        # 5. éªŒè¯è®¾ç½®
        print("ğŸ” éªŒè¯è´¦æˆ·è®¾ç½®...")
        balance = exchange.fetch_balance()
        usdt_balance = balance['USDT']['free']
        print(f"ğŸ’° å½“å‰USDTä½™é¢: {usdt_balance:.2f}")

        # è·å–å½“å‰æŒä»“çŠ¶æ€
        current_pos = get_current_position()
        if current_pos:
            print(f"ğŸ“¦ å½“å‰æŒä»“: {current_pos['side']}ä»“ {current_pos['size']}å¼ ")
        else:
            print("ğŸ“¦ å½“å‰æ— æŒä»“")

        print("ğŸ¯ ç¨‹åºé…ç½®å®Œæˆï¼šå…¨ä»“æ¨¡å¼ + å•å‘æŒä»“")
        return True

    except Exception as e:
        print(f"âŒ äº¤æ˜“æ‰€è®¾ç½®å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return False

